<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analizador Energ√©tico Avanzado</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container { max-width: 1600px; margin: 0 auto; }

        .header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 20px;
            text-align: center;
        }

        .header h1 { color: #667eea; font-size: 2.5em; margin-bottom: 10px; }

        .upload-section {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 20px;
            text-align: center;
        }

        .file-input-wrapper { position: relative; display: inline-block; margin: 20px 0; }
        .file-input-wrapper input[type=file] { display: none; }

        .file-input-label {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 40px;
            border-radius: 50px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: bold;
            transition: transform 0.2s;
            display: inline-block;
        }

        .file-input-label:hover { transform: scale(1.05); }

        .config-section {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .config-item { display: flex; flex-direction: column; }
        .config-item label { font-weight: bold; margin-bottom: 5px; color: #555; }
        .config-item input, .config-item select {
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
        }

        .dashboard { display: none; }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .metric-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: transform 0.2s;
        }

        .metric-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        }

        .metric-icon { font-size: 2.5em; margin-bottom: 10px; }
        .metric-value { font-size: 2em; font-weight: bold; color: #667eea; margin: 10px 0; }
        .metric-label { color: #666; font-size: 0.9em; }
        .metric-detail { color: #999; font-size: 0.85em; margin-top: 10px; padding-top: 10px; border-top: 1px solid #eee; }

        .alert-badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: bold;
            margin-top: 10px;
        }

        .alert-danger { background: #fee; color: #c33; }
        .alert-warning { background: #ffc; color: #c93; }
        .alert-success { background: #efe; color: #3c3; }
        .alert-info { background: #e3f2fd; color: #1976d2; }

        .chart-container {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .chart-container h3 {
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }

        .chart-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 20px;
        }

        .insights-section {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .insight-item {
            padding: 15px;
            margin: 10px 0;
            border-left: 4px solid #667eea;
            background: #f8f9ff;
            border-radius: 8px;
        }

        .insight-title { font-weight: bold; color: #667eea; font-size: 1.1em; margin-bottom: 5px; }
        .insight-description { color: #666; line-height: 1.6; }
        .insight-recommendation { color: #2ecc71; margin-top: 10px; font-weight: bold; }

        .appliances-list { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }

        .appliance-item {
            padding: 15px;
            margin: 10px 0;
            border-left: 4px solid #667eea;
            background: #f8f9ff;
            border-radius: 8px;
        }

        .appliance-time { font-weight: bold; color: #667eea; }
        .appliance-power { font-size: 1.2em; color: #333; margin: 5px 0; }
        .appliance-type { color: #666; font-style: italic; }

        .loading { text-align: center; padding: 40px; color: #667eea; font-size: 1.2em; }

        .tabs { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }

        .tab {
            background: white;
            padding: 15px 30px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .tab:hover { background: #f0f0f0; }
        .tab.active { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .comparison-table th {
            background: #667eea;
            color: white;
            padding: 12px;
            text-align: left;
        }

        .comparison-table td {
            padding: 12px;
            border-bottom: 1px solid #ddd;
        }

        .comparison-table tr:hover { background: #f5f5f5; }

        .heatmap-container {
            display: grid;
            grid-template-columns: repeat(24, 1fr);
            gap: 2px;
            margin-top: 20px;
        }

        .heatmap-cell {
            aspect-ratio: 1;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7em;
            color: white;
            font-weight: bold;
        }

        .heatmap-label {
            grid-column: 1 / -1;
            text-align: center;
            font-weight: bold;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>‚ö° Analizador Energ√©tico Avanzado</h1>
            <p>Inteligencia artificial para optimizar tu consumo el√©ctrico</p>
        </div>

        <div class="upload-section">
            <h2>üìä Cargar datos de InfluxDB</h2>
            <p>An√°lisis profundo con machine learning y reconocimiento de patrones</p>

            <div class="file-input-wrapper">
                <input type="file" id="csvFile" accept=".csv" />
                <label for="csvFile" class="file-input-label">üìÅ Seleccionar archivo CSV</label>
            </div>

            <div class="config-section">
                <div class="config-item">
                    <label>üí∞ Precio kWh (MXN)</label>
                    <input type="number" id="precioKwh" value="2.5" step="0.1" />
                </div>
                <div class="config-item">
                    <label>‚ö†Ô∏è Umbral pico (W)</label>
                    <input type="number" id="umbralPico" value="300" step="50" />
                </div>
                <div class="config-item">
                    <label>üåô Base esperada (W)</label>
                    <input type="number" id="consumoBaseEsperado" value="100" step="10" />
                </div>
                <div class="config-item">
                    <label>üìä Tarifa CFE</label>
                    <select id="tarifaCFE">
                        <option value="domestica">Dom√©stica</option>
                        <option value="dac">DAC (Alto Consumo)</option>
                    </select>
                </div>
            </div>

            <div id="loading" class="loading" style="display:none;">‚è≥ Analizando datos con IA...</div>

            <div class="config-section" style="margin-top: 30px;">
                <h3>üåç Correlaciones Contextuales</h3>
                <div class="config-item">
                    <label>üìç Ubicaci√≥n (para clima)</label>
                    <input type="text" id="location" placeholder="Ej: Ciudad de M√©xico" />
                </div>
                <div class="config-item">
                    <label>üìÖ Anotar Evento</label>
                    <input type="date" id="eventDate" />
                    <input type="text" id="eventDescription" placeholder="Ej: Vacaciones" style="margin-top: 5px;" />
                    <button onclick="addEvent()" style="margin-top: 5px; padding: 8px; background: #667eea; color: white; border: none; border-radius: 5px;">A√±adir Evento</button>
                </div>
                <div id="eventList" style="grid-column: 1 / -1;"></div>
            </div>

            <div class="config-section" style="margin-top: 30px;">
                <h3>üîÆ Simulador de Optimizaci√≥n</h3>
                <div class="config-item">
                    <label>¬øQu√© pasar√≠a si...?</label>
                    <select id="whatIfScenario" onchange="simularOptimizacion()">
                        <option value="none">Selecciona una acci√≥n</option>
                        <option value="reducirPhantom50">Reduzco fantasma 50%</option>
                        <option value="mejorarFP">Subo factor potencia a 0.95</option>
                        <option value="reprogramarPico">Muevo el pico a hora valle</option>
                        <option value="aislarCasa">Reduzco dependencia t√©rmica 30%</option>
                    </select>
                </div>
                <div id="simulationResult" class="metrics-grid" style="display:none;"></div>
            </div>
    <div style="margin-top: 20px;">
        <button onclick="generarReporteEjecutivo()" style="padding: 10px 20px; background: #27ae60; color: white; border: none; border-radius: 8px; cursor: pointer;">
            üìÑ Exportar Reporte Ejecutivo
        </button>
    </div>
        </div>

        <div id="dashboard" class="dashboard">
            <div class="tabs">
                <div class="tab active" onclick="switchTab('resumen')">üìä Resumen Ejecutivo</div>
                <div class="tab" onclick="switchTab('insights')">üß† Insights IA</div>
                <div class="tab" onclick="switchTab('patrones')">üìà Patrones Avanzados</div>
                <div class="tab" onclick="switchTab('electrodomesticos')">üîå Electrodom√©sticos</div>
                <div class="tab" onclick="switchTab('comparativas')">üìä Comparativas</div>
                <div class="tab" onclick="switchTab('predicciones')">üîÆ Predicciones</div>
                <div class="tab" onclick="switchTab('causal')">üîó An√°lisis Causal</div>
                <div class="tab" onclick="switchTab('ocupacion')">üè† Ocupaci√≥n</div>
            </div>

            <div id="tab-resumen" class="tab-content active">
                <div class="metrics-grid" id="metricsGrid"></div>
                <div class="chart-container">
                    <h3>üìà L√≠nea de tiempo completa con eventos detectados</h3>
                    <canvas id="mainChart"></canvas>
                </div>
            </div>

            <div id="tab-insights" class="tab-content">
                <div class="insights-section">
                    <h3>üß† An√°lisis Inteligente de Consumo</h3>
                    <div id="insightsList"></div>
                </div>
                <div class="chart-grid">
                    <div class="chart-container">
                        <h3>üéØ Distribuci√≥n de consumo</h3>
                        <canvas id="distributionChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <h3>üìä Factor de potencia en tiempo real</h3>
                        <canvas id="powerFactorTimeChart"></canvas>
                    </div>
                </div>
            </div>

            <div id="tab-patrones" class="tab-content">
                <div class="chart-container">
                    <h3>üî• Mapa de calor: Consumo por hora y d√≠a</h3>
                    <div id="heatmapContainer"></div>
                </div>
                <div class="chart-grid">
                    <div class="chart-container">
                        <h3>üïê Patr√≥n circadiano (24h)</h3>
                        <canvas id="hourlyChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <h3>üìÖ Patr√≥n semanal</h3>
                        <canvas id="weeklyChart"></canvas>
                    </div>
                </div>
                <div class="chart-container">
                    <h3>üìä Variabilidad del consumo</h3>
                    <canvas id="variabilityChart"></canvas>
                </div>
            </div>

            <div id="tab-electrodomesticos" class="tab-content">
                <div class="metrics-grid" id="appliancesMetrics"></div>
                <div class="appliances-list">
                    <h3>üîå Top 30 eventos de encendido detectados</h3>
                    <div id="appliancesList"></div>
                </div>
            </div>

            <div id="tab-comparativas" class="tab-content">
                <div class="insights-section">
                    <h3>üìä Benchmarking y Comparativas</h3>
                    <div id="comparativesList"></div>
                </div>
                <div class="chart-container">
                    <h3>üìà Tu hogar vs. Promedio nacional</h3>
                    <canvas id="benchmarkChart"></canvas>
                </div>
            </div>

            <div id="tab-predicciones" class="tab-content">
                <div class="metrics-grid" id="predictionsMetrics"></div>
                <div class="chart-container">
                    <h3>üîÆ Proyecci√≥n de consumo y costo (30 d√≠as)</h3>
                    <canvas id="predictionChart"></canvas>
                </div>
                <div class="insights-section">
                    <h3>üí° Recomendaciones personalizadas</h3>
                    <div id="recommendationsList"></div>
                </div>
            </div>

            <div id="tab-causal" class="tab-content">
                <div class="insights-section">
                    <h3>üîó Modelo Causal de Consumo</h3>
                    <div id="causalModel"></div>
                </div>
                <div class="chart-container">
                    <h3>üéØ Impacto de Variables Externas</h3>
                    <canvas id="causalChart"></canvas>
                </div>
                <div class="metrics-grid" id="causalMetrics"></div>
            </div>
            <div id="tab-ocupacion" class="tab-content">
                <div class="metrics-grid" id="occupancyMetrics"></div>
                <div class="chart-container">
                    <h3>üìà Ocupaci√≥n estimada vs. Consumo</h3>
                    <canvas id="occupancyChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script>
        let chartInstances = {};
        let analyzedData = null;
        let events = JSON.parse(localStorage.getItem('events')) || [];

        function estimateOccupancy(data) {
            const occupancy = [];
            for (let i = 1; i < data.length; i++) {
                const diff = Math.abs(data[i].power - data[i-1].power);
                if (diff > 50) {
                    occupancy.push({ time: data[i].time, occupied: 1 });
                } else {
                    occupancy.push({ time: data[i].time, occupied: 0 });
                }
            }
            return occupancy;
        }

        function addEvent() {
            const date = document.getElementById('eventDate').value;
            const description = document.getElementById('eventDescription').value;
            if (date && description) {
                events.push({ date, description });
                localStorage.setItem('events', JSON.stringify(events));
                renderEvents();
                document.getElementById('eventDate').value = '';
                document.getElementById('eventDescription').value = '';
            }
        }

        function deleteEvent(index) {
            events.splice(index, 1);
            localStorage.setItem('events', JSON.stringify(events));
            renderEvents();
        }

        function renderEvents() {
            const eventList = document.getElementById('eventList');
            eventList.innerHTML = events.map((event, index) => `
                <div class="event-item" style="display: flex; justify-content: space-between; align-items: center; padding: 5px; border-bottom: 1px solid #eee;">
                    <span><strong>${event.date}:</strong> ${event.description}</span>
                    <button onclick="deleteEvent(${index})" style="background: #e74c3c; color: white; border: none; border-radius: 5px; padding: 3px 8px;">X</button>
                </div>
            `).join('');
        }

        async function fetchWeatherData(latitude, longitude, startDate, endDate) {
            const url = `https://archive-api.open-meteo.com/v1/archive?latitude=${latitude}&longitude=${longitude}&start_date=${startDate}&end_date=${endDate}&hourly=temperature_2m,relative_humidity_2m`;
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    console.error('Error fetching weather data:', response.statusText);
                    return null;
                }
                const data = await response.json();
                return data;
            } catch (error) {
                console.error('Error fetching weather data:', error);
                return null;
            }
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(`tab-${tabName}`).classList.add('active');
        }

        function clasificarAparato(watts) {
            watts = Math.round(watts);
            if (watts > 2500) return { tipo: 'üöø Regadera el√©ctrica / HVAC', color: '#e74c3c', categoria: 'Alto consumo' };
            if (watts > 1500) return { tipo: 'üç≥ Horno / Parrilla inducci√≥n', color: '#e67e22', categoria: 'Alto consumo' };
            if (watts > 800) return { tipo: 'üì± Microondas / Cafetera', color: '#f39c12', categoria: 'Medio consumo' };
            if (watts > 300) return { tipo: 'üëï Lavadora / Motor', color: '#3498db', categoria: 'Medio consumo' };
            if (watts > 100) return { tipo: '‚ùÑÔ∏è Refrigerador / Ventilador', color: '#1abc9c', categoria: 'Bajo consumo' };
            return { tipo: 'üíª Electr√≥nica / Iluminaci√≥n', color: '#95a5a6', categoria: 'Bajo consumo' };
        }

        document.getElementById('csvFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            document.getElementById('loading').style.display = 'block';

            Papa.parse(file, {
                header: true,
                skipEmptyLines: true,
                comments: '#',
                complete: function(results) {
                    setTimeout(() => {
                        procesarDatos(results.data);
                        document.getElementById('loading').style.display = 'none';
                        document.getElementById('dashboard').style.display = 'block';
                    }, 500);
                },
                error: function(error) {
                    alert('Error: ' + error.message);
                    document.getElementById('loading').style.display = 'none';
                }
            });
        });

        document.addEventListener('DOMContentLoaded', renderEvents);

        async function getCoordinates(location) {
            if (!location) return null;
            const url = `https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(location)}`;
            try {
                const response = await fetch(url);
                const data = await response.json();
                if (data.results && data.results.length > 0) {
                    return {
                        latitude: data.results[0].latitude,
                        longitude: data.results[0].longitude
                    };
                }
                return null;
            } catch (error) {
                console.error('Error fetching coordinates:', error);
                return null;
            }
        }

        async function procesarDatos(data) {
            const precioKwh = parseFloat(document.getElementById('precioKwh').value);
            const umbralPico = parseFloat(document.getElementById('umbralPico').value);
            const consumoBaseEsperado = parseFloat(document.getElementById('consumoBaseEsperado').value);
            const tarifaCFE = document.getElementById('tarifaCFE').value;

            const datosLimpios = data
                .filter(row => row.time && row.power && row.power_factor)
                .map(row => ({
                    time: new Date(row.time),
                    power: parseFloat(row.power),
                    powerFactor: parseFloat(row.power_factor)
                }))
                .filter(row => !isNaN(row.power) && !isNaN(row.powerFactor))
                .sort((a, b) => a.time - b.time);

            if (datosLimpios.length === 0) {
                alert('No se encontraron datos v√°lidos');
                return;
            }

            const location = document.getElementById('location').value;
            const coordinates = await getCoordinates(location);
            let weatherData = null;
            if (coordinates) {
                const startDate = datosLimpios[0].time.toISOString().slice(0, 10);
                const endDate = datosLimpios[datosLimpios.length - 1].time.toISOString().slice(0, 10);
                weatherData = await fetchWeatherData(coordinates.latitude, coordinates.longitude, startDate, endDate);
            }

            if (weatherData && weatherData.hourly) {
                const weatherMap = new Map();
                weatherData.hourly.time.forEach((t, i) => {
                    weatherMap.set(new Date(t).getTime(), {
                        temperature: weatherData.hourly.temperature_2m[i],
                        humidity: weatherData.hourly.relative_humidity_2m[i]
                    });
                });

                datosLimpios.forEach(d => {
                    const weather = weatherMap.get(d.time.getTime());
                    if (weather) {
                        d.temperature = weather.temperature;
                        d.humidity = weather.humidity;
                    }
                });
            }

            // An√°lisis estad√≠stico avanzado
            const potencias = datosLimpios.map(d => d.power);
            const consumoPromedio = potencias.reduce((a, b) => a + b, 0) / potencias.length;
            const consumoMaximo = Math.max(...potencias);
            const consumoMinimo = Math.min(...potencias);

            // Desviaci√≥n est√°ndar
            const varianza = potencias.reduce((sum, val) => sum + Math.pow(val - consumoPromedio, 2), 0) / potencias.length;
            const desviacionEstandar = Math.sqrt(varianza);

            // Percentiles
            const potenciasOrdenadas = [...potencias].sort((a, b) => a - b);
            const p25 = potenciasOrdenadas[Math.floor(potencias.length * 0.25)];
            const p50 = potenciasOrdenadas[Math.floor(potencias.length * 0.50)];
            const p75 = potenciasOrdenadas[Math.floor(potencias.length * 0.75)];
            const p95 = potenciasOrdenadas[Math.floor(potencias.length * 0.95)];

            // Consumo base
            const datosNoche = datosLimpios.filter(d => {
                const hora = d.time.getHours();
                return hora >= 2 && hora <= 4;
            });
            const consumoBase = datosNoche.length > 0
                ? datosNoche.reduce((a, b) => a + b.power, 0) / datosNoche.length
                : p25;

            // Factor de potencia
            const fpDatos = datosLimpios.filter(d => d.power > 20);
            const factorPotenciaPromedio = fpDatos.reduce((a, b) => a + b.powerFactor, 0) / fpDatos.length;
            const fpMinimo = Math.min(...fpDatos.map(d => d.powerFactor));

            // Detecci√≥n de picos
            const picos = [];
            for (let i = 1; i < datosLimpios.length; i++) {
                const diff = datosLimpios[i].power - datosLimpios[i-1].power;
                if (diff > umbralPico) {
                    picos.push({
                        time: datosLimpios[i].time,
                        power: datosLimpios[i].power,
                        diff: diff,
                        clasificacion: clasificarAparato(diff)
                    });
                }
            }
            picos.sort((a, b) => b.diff - a.diff);

            // Conteo por categor√≠a
            const categorias = {};
            picos.forEach(p => {
                const cat = p.clasificacion.categoria;
                categorias[cat] = (categorias[cat] || 0) + 1;
            });

            // Patr√≥n por hora (con desviaci√≥n)
            const consumoPorHora = Array(24).fill(0).map(() => []);
            datosLimpios.forEach(d => {
                consumoPorHora[d.time.getHours()].push(d.power);
            });
            const promedioPorHora = consumoPorHora.map(arr =>
                arr.length > 0 ? arr.reduce((a, b) => a + b, 0) / arr.length : 0
            );
            const desviacionPorHora = consumoPorHora.map(arr => {
                if (arr.length < 2) return 0;
                const avg = arr.reduce((a, b) => a + b, 0) / arr.length;
                const variance = arr.reduce((sum, val) => sum + Math.pow(val - avg, 2), 0) / arr.length;
                return Math.sqrt(variance);
            });

            // Patr√≥n por d√≠a de la semana
            const diasSemana = ['Dom', 'Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b'];
            const consumoPorDia = Array(7).fill(0).map(() => []);
            datosLimpios.forEach(d => {
                consumoPorDia[d.time.getDay()].push(d.power);
            });
            const promedioPorDia = consumoPorDia.map(arr =>
                arr.length > 0 ? arr.reduce((a, b) => a + b, 0) / arr.length : 0
            );

            // Mapa de calor (d√≠a x hora)
            const mapaCalor = Array(7).fill(0).map(() => Array(24).fill(0).map(() => []));
            datosLimpios.forEach(d => {
                mapaCalor[d.time.getDay()][d.time.getHours()].push(d.power);
            });
            const mapaCalorPromedio = mapaCalor.map(dia =>
                dia.map(hora => hora.length > 0 ? hora.reduce((a,b) => a+b, 0) / hora.length : 0)
            );

            // Costos
            const diasDatos = (datosLimpios[datosLimpios.length - 1].time - datosLimpios[0].time) / (1000 * 60 * 60 * 24);
            const kwhTotal = (consumoPromedio * 24 * diasDatos) / 1000;
            const costoTotal = kwhTotal * precioKwh;
            const costoMes = (consumoPromedio * 24 * 30.5) / 1000 * precioKwh;
            const costoFantasmaMes = (consumoBase * 24 * 30.5) / 1000 * precioKwh;
            const ahorroMensual = ((consumoBase - consumoBaseEsperado) * 24 * 30.5) / 1000 * precioKwh;

            // Proyecciones
            const tendencia = calcularTendencia(datosLimpios);
            const consumoProyectado30d = consumoPromedio * (1 + tendencia * 30);
            const costoProyectado30d = (consumoProyectado30d * 24 * 30) / 1000 * precioKwh;

            // Benchmarking (datos aproximados de M√©xico)
            const promedioNacionalMensual = 300; // kWh
            const tuConsumoMensual = (consumoPromedio * 24 * 30.5) / 1000;
            const comparativoNacional = ((tuConsumoMensual - promedioNacionalMensual) / promedioNacionalMensual) * 100;

            analyzedData = {
                datosLimpios, consumoPromedio, consumoMaximo, consumoMinimo,
                desviacionEstandar, p25, p50, p75, p95,
                consumoBase, factorPotenciaPromedio, fpMinimo,
                picos, categorias,
                promedioPorHora, desviacionPorHora,
                promedioPorDia, diasSemana,
                mapaCalorPromedio,
                diasDatos, kwhTotal, costoTotal, costoMes,
                costoFantasmaMes, ahorroMensual,
                tendencia, consumoProyectado30d, costoProyectado30d,
                tuConsumoMensual, promedioNacionalMensual, comparativoNacional,
                precioKwh, tarifaCFE
            };

            const componentes = calcularComponentesTemporales(datosLimpios);
            analyzedData.scoreEficiencia = calcularScoreEficiencia();
            analyzedData.clusters = clusterizarDispositivos();
            analyzedData.desgaste = analizarDesgaste();
            analyzedData.deteccionAnomalias = componentes.residuales;
            analyzedData.occupancy = estimateOccupancy(datosLimpios);

            renderizarDashboard();
        }

        function calcularTendencia(datos) {
            const n = Math.min(datos.length, 1000);
            let sumX = 0, sumY = 0, sumXY = 0, sumX2 = 0;

            for (let i = 0; i < n; i++) {
                sumX += i;
                sumY += datos[i].power;
                sumXY += i * datos[i].power;
                sumX2 += i * i;
            }

            const pendiente = (n * sumXY - sumX * sumY) / (n * sumX2 - sumX * sumX);
            return pendiente / datos[0].power;
        }

        function renderizarDashboard() {
            renderMetricsGrid();
            renderInsights();
            renderMainChart();
            renderDistributionChart();
            renderPowerFactorTimeChart();
            renderHeatmap();
            renderHourlyChart();
            renderWeeklyChart();
            renderVariabilityChart();
            renderAppliancesMetrics();
            renderAppliancesList();
            renderComparatives();
            renderBenchmarkChart();
            renderPredictionsMetrics();
            renderPredictionChart();
            renderRecommendations();
            renderCausalAnalysis();
            renderOccupancyMetrics();
            renderOccupancyChart();
            document.getElementById('insightsList').innerHTML += generarDiagnosticoNLP();
        }

        function renderMetricsGrid() {
            const d = analyzedData;
            document.getElementById('metricsGrid').innerHTML = `
                <div class="metric-card">
                    <div class="metric-icon">‚ö°</div>
                    <div class="metric-label">Consumo Promedio</div>
                    <div class="metric-value">${d.consumoPromedio.toFixed(0)} W</div>
                    <div class="metric-detail">
                        Mediana: ${d.p50.toFixed(0)} W<br>
                        Desv. Std: ¬±${d.desviacionEstandar.toFixed(0)} W
                    </div>
                </div>

                <div class="metric-card">
                    <div class="metric-icon">üí∞</div>
                    <div class="metric-label">Costo Mensual</div>
                    <div class="metric-value">$${d.costoMes.toFixed(2)}</div>
                    <div class="metric-detail">
                        ${d.diasDatos.toFixed(1)} d√≠as: $${d.costoTotal.toFixed(2)}<br>
                        ${d.tuConsumoMensual.toFixed(0)} kWh/mes
                    </div>
                </div>

                <div class="metric-card">
                    <div class="metric-icon">üåô</div>
                    <div class="metric-label">Consumo Fantasma</div>
                    <div class="metric-value">${d.consumoBase.toFixed(0)} W</div>
                    <div class="metric-detail">
                        $${d.costoFantasmaMes.toFixed(2)}/mes
                        ${d.consumoBase > 150 ? '<br><span class="alert-badge alert-danger">‚ö†Ô∏è Muy alto</span>' :
                          d.consumoBase > 100 ? '<br><span class="alert-badge alert-warning">‚ö†Ô∏è Alto</span>' :
                          '<br><span class="alert-badge alert-success">‚úì √ìptimo</span>'}
                    </div>
                </div>

                <div class="metric-card">
                    <div class="metric-icon">üìä</div>
                    <div class="metric-label">Factor de Potencia</div>
                    <div class="metric-value">${d.factorPotenciaPromedio.toFixed(3)}</div>
                    <div class="metric-detail">
                        M√≠nimo: ${d.fpMinimo.toFixed(3)}<br>
                        ${d.factorPotenciaPromedio < 0.8 ? '<span class="alert-badge alert-danger">‚ö†Ô∏è Muy bajo</span>' :
                          d.factorPotenciaPromedio < 0.9 ? '<span class="alert-badge alert-warning">‚ö†Ô∏è Regular</span>' :
                          '<span class="alert-badge alert-success">‚úì Excelente</span>'}
                    </div>
                </div>

                <div class="metric-card">
                    <div class="metric-icon">üéØ</div>
                    <div class="metric-label">Picos Detectados</div>
                    <div class="metric-value">${d.picos.length}</div>
                    <div class="metric-detail">
                        Alto consumo: ${d.categorias['Alto consumo'] || 0}<br>
                        Medio: ${d.categorias['Medio consumo'] || 0}<br>
                        Bajo: ${d.categorias['Bajo consumo'] || 0}
                    </div>
                </div>

                <div class="metric-card">
                    <div class="metric-icon">üìà</div>
                    <div class="metric-label">Tendencia</div>
                    <div class="metric-value">${(d.tendencia * 100).toFixed(2)}%</div>
                    <div class="metric-detail">
                        ${d.tendencia > 0 ? 'üìà Incrementando' : 'üìâ Disminuyendo'}<br>
                        ${Math.abs(d.tendencia * 100).toFixed(2)}% por d√≠a
                    </div>
                </div>
            `;
        }

        function renderInsights() {
            const d = analyzedData;
            let insights = [];

            // Insight 1: Consumo fantasma
            if (d.consumoBase > 150) {
                insights.push({
                    icon: 'üåô',
                    title: 'Consumo fantasma cr√≠tico detectado',
                    description: `Tu hogar consume ${d.consumoBase.toFixed(0)}W cuando "no usas nada". Esto representa el ${((d.consumoBase/d.consumoPromedio)*100).toFixed(1)}% de tu consumo promedio y te cuesta ${d.costoFantasmaMes.toFixed(2)} MXN al mes.`,
                    recommendation: `üí° Recomendaci√≥n: Desconecta cargadores, apaga regletas, considera smart plugs. Ahorro potencial: ${d.ahorroMensual.toFixed(2)} MXN/mes`
                });
            }

            // Insight 2: Factor de potencia
            if (d.factorPotenciaPromedio < 0.85) {
                insights.push({
                    icon: '‚ö†Ô∏è',
                    title: 'Equipos ineficientes detectados',
                    description: `Tu factor de potencia promedio es ${d.factorPotenciaPromedio.toFixed(3)} (ideal >0.9). Esto indica equipos de mala calidad, cargadores gen√©ricos o motores viejos que desperdician energ√≠a.`,
                    recommendation: `üí° Recomendaci√≥n: Reemplaza cargadores baratos, considera actualizar electrodom√©sticos viejos. Mejora potencial: 10-15% en eficiencia.`
                });
            }

            // Insight 3: Variabilidad
            const cv = (d.desviacionEstandar / d.consumoPromedio) * 100;
            if (cv > 50) {
                insights.push({
                    icon: 'üìä',
                    title: 'Alta variabilidad en consumo',
                    description: `Tu consumo var√≠a significativamente (CV: ${cv.toFixed(1)}%). Esto sugiere uso irregular de electrodom√©sticos de alto consumo o picos frecuentes.`,
                    recommendation: `üí° Recomendaci√≥n: Programa electrodom√©sticos grandes en horarios valle, evita usar m√∫ltiples aparatos simult√°neamente.`
                });
            }

            // Insight 4: Hora pico
            const horaPico = d.promedioPorHora.indexOf(Math.max(...d.promedioPorHora));
            const consumoHoraPico = d.promedioPorHora[horaPico];
            if (consumoHoraPico > d.consumoPromedio * 1.5) {
                insights.push({
                    icon: 'üïê',
                    title: `Pico de consumo a las ${horaPico}:00 hrs`,
                    description: `Entre las ${horaPico}:00-${horaPico+1}:00 tu consumo promedio es ${consumoHoraPico.toFixed(0)}W, un ${(((consumoHoraPico/d.consumoPromedio)-1)*100).toFixed(0)}% m√°s alto que tu promedio diario.`,
                    recommendation: `üí° Recomendaci√≥n: Identifica qu√© aparatos usas a esta hora y considera reprogramarlos a horarios de menor consumo.`
                });
            }

            // Insight 5: Comparativo nacional
            if (d.comparativoNacional > 20) {
                insights.push({
                    icon: 'üìä',
                    title: 'Consumo por encima del promedio nacional',
                    description: `Tu consumo mensual (${d.tuConsumoMensual.toFixed(0)} kWh) es ${Math.abs(d.comparativoNacional).toFixed(0)}% mayor que el promedio nacional mexicano (${d.promedioNacionalMensual} kWh/mes).`,
                    recommendation: `üí° Recomendaci√≥n: Revisa la secci√≥n de Electrodom√©sticos para identificar equipos que consumen m√°s de lo normal.`
                });
            } else if (d.comparativoNacional < -20) {
                insights.push({
                    icon: 'üåü',
                    title: '¬°Consumo eficiente!',
                    description: `Felicidades, tu consumo est√° ${Math.abs(d.comparativoNacional).toFixed(0)}% por debajo del promedio nacional. Esto indica buenos h√°bitos de ahorro energ√©tico.`,
                    recommendation: `üí° Sigue as√≠: Mant√©n estos h√°bitos y comparte tus tips con familiares.`
                });
            }

            // Insight 6: Proyecci√≥n
            if (Math.abs(d.tendencia) > 0.01) {
                const direccion = d.tendencia > 0 ? 'incrementar√°' : 'disminuir√°';
                insights.push({
                    icon: 'üîÆ',
                    title: `Tu consumo ${direccion} en los pr√≥ximos d√≠as`,
                    description: `Basado en la tendencia actual (${(d.tendencia*100).toFixed(2)}%/d√≠a), se proyecta que en 30 d√≠as tu consumo ser√° de ${d.consumoProyectado30d.toFixed(0)}W promedio, con un costo de ${d.costoProyectado30d.toFixed(2)} MXN.`,
                    recommendation: d.tendencia > 0 ?
                        `‚ö†Ô∏è Alerta: Tu consumo est√° aumentando. Revisa qu√© ha cambiado recientemente (nuevo equipo, m√°s uso de AC, etc.)` :
                        `‚úÖ Excelente: Tu consumo est√° bajando. ¬°Sigue con esos buenos h√°bitos!`
                });
            }

            const html = insights.map(insight => `
                <div class="insight-item">
                    <div class="insight-title">${insight.icon} ${insight.title}</div>
                    <div class="insight-description">${insight.description}</div>
                    <div class="insight-recommendation">${insight.recommendation}</div>
                </div>
            `).join('');

            document.getElementById('insightsList').innerHTML = html || '<p>No hay insights cr√≠ticos. Tu consumo parece normal.</p>';
        }

        function renderMainChart() {
            const d = analyzedData;
            const ctx = document.getElementById('mainChart').getContext('2d');
            if (chartInstances.main) chartInstances.main.destroy();

            const agrupado = {};
            d.datosLimpios.forEach(dato => {
                const key = dato.time.toISOString().slice(0, 13) + ':00:00';
                if (!agrupado[key]) agrupado[key] = [];
                agrupado[key].push(dato.power);
            });

            const labels = Object.keys(agrupado).sort();
            const valores = labels.map(k => agrupado[k].reduce((a,b) => a+b, 0) / agrupado[k].length);

            const eventAnnotations = events.map(event => {
                return {
                    type: 'line',
                    mode: 'vertical',
                    scaleID: 'x',
                    value: new Date(event.date).toLocaleString('es-MX', { month: 'short', day: 'numeric', hour: '2-digit' }),
                    borderColor: 'red',
                    borderWidth: 2,
                    label: {
                        content: event.description,
                        enabled: true,
                        position: 'top'
                    }
                }
            });

            chartInstances.main = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels.map(l => new Date(l).toLocaleString('es-MX', { month: 'short', day: 'numeric', hour: '2-digit' })),
                    datasets: [{
                        label: 'Consumo Real (W)',
                        data: valores,
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        fill: true,
                        tension: 0.4
                    }, {
                        label: 'Consumo Base',
                        data: Array(labels.length).fill(d.consumoBase),
                        borderColor: '#e74c3c',
                        borderDash: [5, 5],
                        fill: false,
                        pointRadius: 0
                    }, {
                        label: 'Promedio',
                        data: Array(labels.length).fill(d.consumoPromedio),
                        borderColor: '#2ecc71',
                        borderDash: [2, 2],
                        fill: false,
                        pointRadius: 0
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: true },
                        annotation: {
                            annotations: eventAnnotations
                        }
                    },
                    scales: { y: { beginAtZero: true, title: { display: true, text: 'Watts' } } }
                }
            });
        }

        function renderDistributionChart() {
            const d = analyzedData;
            const ctx = document.getElementById('distributionChart').getContext('2d');
            if (chartInstances.dist) chartInstances.dist.destroy();

            chartInstances.dist = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['M√≠nimo', 'P25', 'Mediana', 'Promedio', 'P75', 'P95', 'M√°ximo'],
                    datasets: [{
                        label: 'Distribuci√≥n (W)',
                        data: [d.consumoMinimo, d.p25, d.p50, d.consumoPromedio, d.p75, d.p95, d.consumoMaximo],
                        backgroundColor: ['#95a5a6', '#3498db', '#1abc9c', '#2ecc71', '#f39c12', '#e67e22', '#e74c3c']
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true } }
                }
            });
        }

        function renderPowerFactorTimeChart() {
            const d = analyzedData;
            const ctx = document.getElementById('powerFactorTimeChart').getContext('2d');
            if (chartInstances.pftime) chartInstances.pftime.destroy();

            const muestras = d.datosLimpios.filter((_, i) => i % 100 === 0).slice(0, 100);

            chartInstances.pftime = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: muestras.map(m => m.time.toLocaleString('es-MX', { month: 'short', day: 'numeric', hour: '2-digit' })),
                    datasets: [{
                        label: 'Factor de Potencia',
                        data: muestras.map(m => m.powerFactor),
                        borderColor: '#9b59b6',
                        backgroundColor: 'rgba(155, 89, 182, 0.1)',
                        fill: true,
                        tension: 0.4
                    }, {
                        label: 'Umbral √≥ptimo (0.9)',
                        data: Array(muestras.length).fill(0.9),
                        borderColor: '#2ecc71',
                        borderDash: [5, 5],
                        pointRadius: 0
                    }]
                },
                options: {
                    responsive: true,
                    scales: { y: { min: 0, max: 1 } }
                }
            });
        }

        function renderHeatmap() {
            const d = analyzedData;
            let html = '<div class="heatmap-label">Consumo promedio por d√≠a y hora (W)</div>';

            const maxVal = Math.max(...d.mapaCalorPromedio.flat());

            d.diasSemana.forEach((dia, i) => {
                html += `<div style="grid-column: 1/-1; font-weight: bold; margin-top: 10px;">${dia}</div>`;
                d.mapaCalorPromedio[i].forEach((val, h) => {
                    const intensity = val / maxVal;
                    const color = `rgb(${Math.round(230-intensity*130)}, ${Math.round(126-intensity*50)}, ${Math.round(234-intensity*134)})`;
                    html += `<div class="heatmap-cell" style="background: ${color}" title="${dia} ${h}:00 - ${val.toFixed(0)}W">${h}</div>`;
                });
            });

            document.getElementById('heatmapContainer').innerHTML = html;
        }

        function renderHourlyChart() {
            const d = analyzedData;
            const ctx = document.getElementById('hourlyChart').getContext('2d');
            if (chartInstances.hourly) chartInstances.hourly.destroy();

            chartInstances.hourly = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Array.from({length: 24}, (_, i) => i + ':00'),
                    datasets: [{
                        label: 'Promedio (W)',
                        data: d.promedioPorHora,
                        backgroundColor: d.promedioPorHora.map(v =>
                            v > d.consumoPromedio * 1.3 ? '#e74c3c' :
                            v > d.consumoPromedio ? '#f39c12' :
                            v < d.consumoPromedio * 0.5 ? '#2ecc71' : '#667eea'
                        )
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true } }
                }
            });
        }

        function renderWeeklyChart() {
            const d = analyzedData;
            const ctx = document.getElementById('weeklyChart').getContext('2d');
            if (chartInstances.weekly) chartInstances.weekly.destroy();

            chartInstances.weekly = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: d.diasSemana,
                    datasets: [{
                        label: 'Promedio (W)',
                        data: d.promedioPorDia,
                        backgroundColor: '#764ba2'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true } }
                }
            });
        }

        function renderVariabilityChart() {
            const d = analyzedData;
            const ctx = document.getElementById('variabilityChart').getContext('2d');
            if (chartInstances.var) chartInstances.var.destroy();

            chartInstances.var = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Array.from({length: 24}, (_, i) => i + ':00'),
                    datasets: [{
                        label: 'Promedio',
                        data: d.promedioPorHora,
                        backgroundColor: 'rgba(102, 126, 234, 0.6)',
                        type: 'bar'
                    }, {
                        label: 'Variabilidad (¬±1œÉ)',
                        data: d.desviacionPorHora,
                        borderColor: '#e74c3c',
                        backgroundColor: 'rgba(231, 76, 60, 0.2)',
                        type: 'line',
                        fill: true
                    }]
                },
                options: { responsive: true, scales: { y: { beginAtZero: true } } }
            });
        }

        function renderAppliancesMetrics() {
            const d = analyzedData;
            const topPico = d.picos[0];
            const consumoAparatos = d.picos.reduce((sum, p) => sum + p.diff, 0) / d.picos.length;

            document.getElementById('appliancesMetrics').innerHTML = `
                <div class="metric-card">
                    <div class="metric-icon">üîå</div>
                    <div class="metric-label">Mayor Pico Detectado</div>
                    <div class="metric-value">${topPico ? topPico.diff.toFixed(0) : 0} W</div>
                    <div class="metric-detail">
                        ${topPico ? topPico.clasificacion.tipo : 'N/A'}<br>
                        ${topPico ? topPico.time.toLocaleString('es-MX') : ''}
                    </div>
                </div>

                <div class="metric-card">
                    <div class="metric-icon">üìä</div>
                    <div class="metric-label">Pico Promedio</div>
                    <div class="metric-value">${consumoAparatos.toFixed(0)} W</div>
                    <div class="metric-detail">
                        ${d.picos.length} eventos detectados<br>
                        en ${d.diasDatos.toFixed(1)} d√≠as
                    </div>
                </div>

                <div class="metric-card">
                    <div class="metric-icon">‚ö°</div>
                    <div class="metric-label">Frecuencia de Uso</div>
                    <div class="metric-value">${(d.picos.length / d.diasDatos).toFixed(1)}</div>
                    <div class="metric-detail">
                        Encendidos por d√≠a<br>
                        ${((d.picos.length / d.diasDatos) * 30).toFixed(0)} veces/mes
                    </div>
                </div>
            `;
        }

        function renderAppliancesList() {
            const d = analyzedData;
            const html = d.picos.slice(0, 30).map((pico, i) => `
                <div class="appliance-item" style="border-left-color: ${pico.clasificacion.color}">
                    <div class="appliance-time">${i + 1}. ${pico.time.toLocaleString('es-MX')}</div>
                    <div class="appliance-power">‚ö° Pico de ${pico.diff.toFixed(0)} W (Total: ${pico.power.toFixed(0)} W)</div>
                    <div class="appliance-type">${pico.clasificacion.tipo} - ${pico.clasificacion.categoria}</div>
                </div>
            `).join('');

            document.getElementById('appliancesList').innerHTML = html || '<p>No se detectaron picos significativos</p>';
        }

        function renderComparatives() {
            const d = analyzedData;

            const html = `
                <table class="comparison-table">
                    <tr>
                        <th>M√©trica</th>
                        <th>Tu Hogar</th>
                        <th>Promedio Nacional</th>
                        <th>Diferencia</th>
                    </tr>
                    <tr>
                        <td>Consumo Mensual</td>
                        <td>${d.tuConsumoMensual.toFixed(0)} kWh</td>
                        <td>${d.promedioNacionalMensual} kWh</td>
                        <td style="color: ${d.comparativoNacional > 0 ? '#e74c3c' : '#2ecc71'}">${d.comparativoNacional > 0 ? '+' : ''}${d.comparativoNacional.toFixed(1)}%</td>
                    </tr>
                    <tr>
                        <td>Costo Mensual</td>
                        <td>${d.costoMes.toFixed(2)} MXN</td>
                        <td>${(d.promedioNacionalMensual * d.precioKwh).toFixed(2)} MXN</td>
                        <td style="color: ${d.costoMes > d.promedioNacionalMensual * d.precioKwh ? '#e74c3c' : '#2ecc71'}">
                            ${d.costoMes > d.promedioNacionalMensual * d.precioKwh ? '+' : ''}${(d.costoMes - d.promedioNacionalMensual * d.precioKwh).toFixed(2)}
                        </td>
                    </tr>
                    <tr>
                        <td>Consumo Base</td>
                        <td>${d.consumoBase.toFixed(0)} W</td>
                        <td>80-120 W (ideal)</td>
                        <td>${d.consumoBase > 120 ? '<span class="alert-badge alert-warning">Alto</span>' : '<span class="alert-badge alert-success">√ìptimo</span>'}</td>
                    </tr>
                    <tr>
                        <td>Factor de Potencia</td>
                        <td>${d.factorPotenciaPromedio.toFixed(3)}</td>
                        <td>>0.90 (ideal)</td>
                        <td>${d.factorPotenciaPromedio < 0.9 ? '<span class="alert-badge alert-warning">Mejorar</span>' : '<span class="alert-badge alert-success">Excelente</span>'}</td>
                    </tr>
                </table>
            `;

            document.getElementById('comparativesList').innerHTML = html;
        }

        function renderBenchmarkChart() {
            const d = analyzedData;
            const ctx = document.getElementById('benchmarkChart').getContext('2d');
            if (chartInstances.bench) chartInstances.bench.destroy();

            chartInstances.bench = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Tu Hogar', 'Promedio Nacional', 'Hogar Eficiente', 'Hogar Ineficiente'],
                    datasets: [{
                        label: 'Consumo Mensual (kWh)',
                        data: [d.tuConsumoMensual, d.promedioNacionalMensual, 200, 500],
                        backgroundColor: ['#667eea', '#95a5a6', '#2ecc71', '#e74c3c']
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true, title: { display: true, text: 'kWh/mes' } } }
                }
            });
        }

        function renderPredictionsMetrics() {
            const d = analyzedData;
            const cambio = d.consumoProyectado30d - d.consumoPromedio;

            document.getElementById('predictionsMetrics').innerHTML = `
                <div class="metric-card">
                    <div class="metric-icon">üîÆ</div>
                    <div class="metric-label">Consumo Proyectado (30d)</div>
                    <div class="metric-value">${d.consumoProyectado30d.toFixed(0)} W</div>
                    <div class="metric-detail">
                        Cambio: ${cambio > 0 ? '+' : ''}${cambio.toFixed(0)} W<br>
                        ${Math.abs((cambio/d.consumoPromedio)*100).toFixed(1)}% vs actual
                    </div>
                </div>

                <div class="metric-card">
                    <div class="metric-icon">üí∞</div>
                    <div class="metric-label">Costo Proyectado (30d)</div>
                    <div class="metric-value">${d.costoProyectado30d.toFixed(2)}</div>
                    <div class="metric-detail">
                        Diferencia: ${(d.costoProyectado30d - d.costoMes).toFixed(2)}<br>
                        ${((d.costoProyectado30d/d.costoMes - 1)*100).toFixed(1)}% vs actual
                    </div>
                </div>

                <div class="metric-card">
                    <div class="metric-icon">üìà</div>
                    <div class="metric-label">Tasa de Crecimiento</div>
                    <div class="metric-value">${(d.tendencia * 100).toFixed(3)}%</div>
                    <div class="metric-detail">
                        Por d√≠a<br>
                        ${d.tendencia > 0 ? '‚ö†Ô∏è Consumo aumentando' : '‚úÖ Consumo disminuyendo'}
                    </div>
                </div>
            `;
        }

        function renderPredictionChart() {
            const d = analyzedData;
            const ctx = document.getElementById('predictionChart').getContext('2d');
            if (chartInstances.pred) chartInstances.pred.destroy();

            const dias = Array.from({length: 31}, (_, i) => i);
            const proyeccion = dias.map(dia => d.consumoPromedio * (1 + d.tendencia * dia));
            const costoProyeccion = proyeccion.map(consumo => (consumo * 24 / 1000) * d.precioKwh);

            chartInstances.pred = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dias.map(d => `D√≠a ${d}`),
                    datasets: [{
                        label: 'Consumo Proyectado (W)',
                        data: proyeccion,
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        fill: true,
                        yAxisID: 'y'
                    }, {
                        label: 'Costo Diario Proyectado (MXN)',
                        data: costoProyeccion,
                        borderColor: '#e74c3c',
                        backgroundColor: 'rgba(231, 76, 60, 0.1)',
                        fill: true,
                        yAxisID: 'y1'
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: { type: 'linear', position: 'left', title: { display: true, text: 'Watts' } },
                        y1: { type: 'linear', position: 'right', title: { display: true, text: 'MXN' }, grid: { drawOnChartArea: false } }
                    }
                }
            });
        }

        function renderRecommendations() {
            const d = analyzedData;
            let recomendaciones = [];

            if (d.ahorroMensual > 50) {
                recomendaciones.push({
                    prioridad: 'ALTA',
                    titulo: 'Eliminar consumo fantasma',
                    descripcion: 'Usa regletas con interruptor, desconecta cargadores',
                    ahorro: `${d.ahorroMensual.toFixed(2)} MXN/mes`,
                    dificultad: 'F√°cil'
                });
            }

            if (d.factorPotenciaPromedio < 0.85) {
                recomendaciones.push({
                    prioridad: 'ALTA',
                    titulo: 'Reemplazar equipos ineficientes',
                    descripcion: 'Cambia cargadores gen√©ricos por originales, actualiza electrodom√©sticos viejos',
                    ahorro: '10-15% en eficiencia',
                    dificultad: 'Media'
                });
            }

            const horaPico = d.promedioPorHora.indexOf(Math.max(...d.promedioPorHora));
            if (d.promedioPorHora[horaPico] > d.consumoPromedio * 1.5) {
                recomendaciones.push({
                    prioridad: 'MEDIA',
                    titulo: `Reprogramar uso de aparatos (${horaPico}:00 hrs)`,
                    descripcion: 'Evita usar lavadora, secadora o AC simult√°neamente',
                    ahorro: 'Reduce picos de demanda',
                    dificultad: 'F√°cil'
                });
            }

            if (d.picos.length > 20) {
                recomendaciones.push({
                    prioridad: 'BAJA',
                    titulo: 'Optimizar ciclos de uso',
                    descripcion: 'Agrupa tareas que requieran los mismos aparatos',
                    ahorro: '5-10% en eficiencia',
                    dificultad: 'F√°cil'
                });
            }

            recomendaciones.push({
                prioridad: 'INFO',
                titulo: 'Monitoreo continuo',
                descripcion: 'Revisa este dashboard semanalmente para detectar cambios',
                ahorro: 'Prevenci√≥n de aumentos',
                dificultad: 'Muy f√°cil'
            });

            const html = recomendaciones.map(rec => {
                const colorPrioridad = rec.prioridad === 'ALTA' ? 'alert-danger' :
                                       rec.prioridad === 'MEDIA' ? 'alert-warning' :
                                       rec.prioridad === 'BAJA' ? 'alert-info' : 'alert-success';
                return `
                    <div class="insight-item">
                        <div class="insight-title">
                            <span class="alert-badge ${colorPrioridad}">${rec.prioridad}</span>
                            ${rec.titulo}
                        </div>
                        <div class="insight-description">
                            ${rec.descripcion}<br>
                            <strong>Ahorro potencial:</strong> ${rec.ahorro}<br>
                            <strong>Dificultad:</strong> ${rec.dificultad}
                        </div>
                    </div>
                `;
            }).join('');

            document.getElementById('recommendationsList').innerHTML = html;
        }

// An√°lisis de descomposici√≥n de series temporales (STL-like)
function calcularComponentesTemporales(datos) {
    // Extrae tendencia, estacionalidad y residual
    const ventana = 24; // 24 horas para suavizado
    const suavizado = datos.map((_, i) => {
        const inicio = Math.max(0, i - ventana/2);
        const fin = Math.min(datos.length, i + ventana/2);
        const ventanaDatos = datos.slice(inicio, fin);
        return ventanaDatos.reduce((a,b) => a + b.power, 0) / ventanaDatos.length;
    });

    // Estacionalidad por hora del d√≠a
    const estacionalidad = Array(24).fill(0).map((_, hora) => {
        const valores = datos.filter(d => d.time.getHours() === hora).map(d => d.power);
        return valores.length > 0 ? valores.reduce((a,b) => a + b, 0) / valores.length : 0;
    });

    // Componente residual (anomal√≠as)
    const residuales = datos.map((d, i) => ({
        time: d.time,
        valor: d.power - (suavizado[i] + estacionalidad[d.time.getHours()])
    })).filter(r => Math.abs(r.valor) > 2 * analyzedData.desviacionEstandar);

    return { suavizado, estacionalidad, residuales };
}

// Sistema de scoring de eficiencia energ√©tica
function calcularScoreEficiencia() {
    const d = analyzedData;
    let score = 100;

    // Penalizaciones ponderadas
    if (d.consumoBase > 150) score -= 25;
    else if (d.consumoBase > 100) score -= 10;

    const cv = (d.desviacionEstandar / d.consumoPromedio) * 100;
    if (cv > 80) score -= 20;
    else if (cv > 50) score -= 10;

    if (d.factorPotenciaPromedio < 0.85) score -= 15;

    const horaPicoRatio = Math.max(...d.promedioPorHora) / d.consumoPromedio;
    if (horaPicoRatio > 2) score -= 15;
    else if (horaPicoRatio > 1.5) score -= 5;

    if (d.comparativoNacional > 50) score -= 20;
    else if (d.comparativoNacional > 20) score -= 10;

    return Math.max(0, Math.min(100, score));
}

// Clustering autom√°tico de dispositivos (k-means simplificado)
function clusterizarDispositivos() {
    const d = analyzedData;
    const picos = d.picos.map(p => ({...p, hora: p.time.getHours()}));

    // Agrupa por similitud de potencia y hora
    const clusters = [];
    const visitados = new Set();

    picos.forEach((pico, i) => {
        if (visitados.has(i)) return;

        const cluster = {
            id: clusters.length,
            tipo: pico.clasificacion,
            picos: [pico],
            horas: new Set([pico.hora]),
            potencias: [pico.diff],
            frecuencia: 1
        };

        // Busca picos similares
        picos.forEach((otro, j) => {
            if (i === j || visitados.has(j)) return;
            const simPotencia = Math.abs(otro.diff - pico.diff) / Math.max(otro.diff, pico.diff) < 0.3;
            const simHora = Math.abs(otro.hora - pico.hora) <= 2;

            if (simPotencia && simHora) {
                cluster.picos.push(otro);
                cluster.horas.add(otro.hora);
                cluster.potencias.push(otro.diff);
                cluster.frecuencia++;
                visitados.add(j);
            }
        });

        clusters.push(cluster);
        visitados.add(i);
    });

    // Calcula estad√≠sticas por cluster
    return clusters.map(c => ({
        ...c,
        potenciaPromedio: c.potencias.reduce((a,b) => a+b, 0) / c.potencias.length,
        horaPreferida: Array.from(c.horas).reduce((a,b) => a+b, 0) / c.horas.size,
        costoMensualEstimado: ((c.potenciaPromedio * 0.5 * c.frecuencia * 30) / 1000) * d.precioKwh
    })).sort((a,b) => b.costoMensualEstimado - a.costoMensualEstimado);
}

// An√°lisis de ciclos de vida de aparatos
function analizarDesgaste() {
    const d = analyzedData;
    const ciclos = d.picos.filter(p => p.clasificacion.categoria === 'Alto consumo');

    // Detecta ciclos de encendido-apagado r√°pidos (posible falla)
    const ciclosRapidos = [];
    for (let i = 1; i < ciclos.length - 1; i++) {
        const tiempoEntreCiclos = (ciclos[i].time - ciclos[i-1].time) / (1000 * 60); // minutos
        if (tiempoEntreCiclos < 30) { // Menos de 30 min
            ciclosRapidos.push({
                aparato: ciclos[i].clasificacion.tipo,
                intervalo: tiempoEntreCiclos,
                timestamp: ciclos[i].time
            });
        }
    }

    return {
        totalCiclos: ciclos.length,
        ciclosRapidos,
        scoreConfiabilidad: ciclosRapidos.length > 0 ? 60 : 100 - Math.min(ciclos.length / 100, 50),
        alerta: ciclosRapidos.length > 3 ? 'Posible aparato defectuoso o mal configurado' : null
    };
}
function calculateCorrelation(arr1, arr2) {
    if (arr1.length !== arr2.length) {
        return NaN;
    }
    let n = 0;
    let sum1 = 0, sum2 = 0, sum1sq = 0, sum2sq = 0, pSum = 0;
    for (let i = 0; i < arr1.length; i++) {
        const val1 = arr1[i];
        const val2 = arr2[i];
        if (val1 !== undefined && val2 !== undefined) {
            n++;
            sum1 += val1;
            sum2 += val2;
            sum1sq += val1 * val1;
            sum2sq += val2 * val2;
            pSum += val1 * val2;
        }
    }
    if (n === 0) {
        return 0;
    }
    const num = pSum - (sum1 * sum2 / n);
    const den = Math.sqrt((sum1sq - sum1 * sum1 / n) * (sum2sq - sum2 * sum2 / n));
    if (den === 0) {
        return 0;
    }
    return num / den;
}
// Implementaci√≥n del an√°lisis causal
        function renderOccupancyMetrics() {
            const d = analyzedData;
            if (d.datosLimpios.length < 2) return;
            const intervalMinutes = (d.datosLimpios[1].time - d.datosLimpios[0].time) / (1000 * 60);
            const occupiedHours = d.occupancy.filter(o => o.occupied).length * intervalMinutes / 60;
            const totalHours = d.datosLimpios.length * intervalMinutes / 60;
            const occupancyPercentage = (occupiedHours / totalHours) * 100;

            document.getElementById('occupancyMetrics').innerHTML = `
                <div class="metric-card">
                    <div class="metric-icon">üè†</div>
                    <div class="metric-label">Horas de Ocupaci√≥n Estimadas</div>
                    <div class="metric-value">${occupiedHours.toFixed(1)} h</div>
                    <div class="metric-detail">
                        ${occupancyPercentage.toFixed(1)}% del tiempo
                    </div>
                </div>
            `;
        }

        function renderOccupancyChart() {
            const d = analyzedData;
            const ctx = document.getElementById('occupancyChart').getContext('2d');
            if (chartInstances.occupancy) chartInstances.occupancy.destroy();

            const labels = d.datosLimpios.map(d => d.time.toLocaleString('es-MX', { month: 'short', day: 'numeric', hour: '2-digit' }));
            const powerData = d.datosLimpios.map(d => d.power);
            const occupancyData = d.occupancy.map(o => o.occupied * Math.max(...powerData)); // Scale occupancy to power max for visualization

            chartInstances.occupancy = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Consumo (W)',
                        data: powerData,
                        borderColor: '#667eea',
                        yAxisID: 'y',
                    }, {
                        label: 'Ocupaci√≥n',
                        data: occupancyData,
                        backgroundColor: 'rgba(255, 159, 64, 0.2)',
                        borderColor: 'rgba(255, 159, 64, 1)',
                        fill: true,
                        stepped: true,
                        yAxisID: 'y1',
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: { type: 'linear', position: 'left', title: { display: true, text: 'Watts' } },
                        y1: { type: 'linear', position: 'right', display: false }
                    }
                }
            });
        }

function renderCausalAnalysis() {
    const d = analyzedData;

    // An√°lisis de Granger Causality simplificado
    const causalFactors = [];

    const tempCorrelation = calculateCorrelation(d.datosLimpios.map(d => d.temperature), d.datosLimpios.map(d => d.power));
    if (!isNaN(tempCorrelation)) {
        causalFactors.push({
            factor: 'üå°Ô∏è Temperatura ambiente',
            impact: `${(tempCorrelation * 100).toFixed(0)}%`,
            explicacion: tempCorrelation > 0.5 ? 'Alta dependencia del clima' : 'Dependencia moderada'
        });
    }

    // D√≠a de la semana
    const weekendRatio = (d.promedioPorDia[0] + d.promedioPorDia[6]) / 2 / d.promedioPorDia[3];
    causalFactors.push({
        factor: 'üìÖ Fin de semana',
        impact: `${((weekendRatio - 1) * 100).toFixed(0)}%`,
        explicacion: weekendRatio > 1.2 ? 'Uso intensivo en fines de semana' : 'Uso consistente'
    });

    // Habitacional vs Industrial
    const ciclosDia = d.picos.filter(p => p.time.getHours() >= 6 && p.time.getHours() <= 22).length;
    const perfil = ciclosDia / d.picos.length > 0.8 ? 'Residencial' : 'Mixto';

    // Renderizado
    document.getElementById('causalModel').innerHTML = `
        <div class="insight-item">
            <div class="insight-title">üè† Perfil de Uso Detectado: ${perfil}</div>
            <div class="insight-description">
                <strong>Variables explicativas del consumo:</strong>
                <ul>${causalFactors.map(f => `<li><strong>${f.factor}:</strong> ${f.impact} de correlaci√≥n - ${f.explicacion}</li>`).join('')}</ul>
            </div>
            <div class="insight-recommendation">
                üí° Si la temperatura explica >50% de tu consumo, considera aislamiento t√©rmico.
                Si los fines de semana disparan el uso, programa tareas pesadas entre semana.
            </div>
        </div>
    `;

    // Gr√°fico de sensibilidad
    const ctx = document.getElementById('causalChart').getContext('2d');
    new Chart(ctx, {
        type: 'scatter',
        data: {
            datasets: [{
                label: 'Consumo vs Hora del d√≠a',
                data: d.datosLimpios.filter((_,i) => i % 50 === 0).map(dt => ({
                    x: dt.time.getHours() + dt.time.getMinutes() / 60,
                    y: dt.power
                })),
                backgroundColor: '#667eea'
            }]
        },
        options: {
            responsive: true,
            scales: {
                x: { title: { display: true, text: 'Hora del d√≠a' } },
                y: { title: { display: true, text: 'Watts' } }
            },
            plugins: {
                legend: { display: false }
            }
        }
    });
}
// Generador de narrativas personalizadas
function generarDiagnosticoNLP() {
    const d = analyzedData;
    const score = d.scoreEficiencia;

    const perfiles = {
        'Excelente': {
            umbral: [80, 100],
            narrativa: `Eres un maestro del ahorro energ√©tico. Tu hogar opera con ${(100-score).toFixed(0)}% menos desperdicio que el promedio. Tu secreto est√° en el uso racional de equipos y probablemente en tecnolog√≠a eficiente.`,
            meta: 'Mant√©n el liderazgo y considera paneles solares'
        },
        'Eficiente': {
            umbral: [60, 79],
            narrativa: `Tienes buenos h√°bitos con margen de optimizaci√≥n. El principal culpable es ${d.consumoBase > 120 ? 'el consumo fantasma nocturno' : 'la variabilidad diaria que indica uso inestable'}.`,
            meta: 'Focal√≠zate en automatizaci√≥n'
        },
        'Mejorable': {
            umbral: [40, 59],
            narrativa: `Tu hogar consume ${Math.abs(d.comparativoNacional).toFixed(0)}% m√°s que el promedio. Detect√© ${d.clusters.filter(c => c.costoMensualEstimado > 100).length} aparatos que te cuestan >$100/mes.`,
            meta: 'Prioriza el reemplazo de equipos grandes'
        },
        'Cr√≠tico': {
            umbral: [0, 39],
            narrativa: `Alerta: Est√°s en el ${100-d.comparativoNacional.toFixed(0)}% de consumo m√°s alto. Hay desperdicio estructural. Identifiqu√© ${d.picos.filter(p => p.diff > 2000).length} eventos de >2000W (posibles fugas t√©rmicas).`,
            meta: 'Auditor√≠a energ√©tica inmediata necesaria'
        }
    };

    const perfil = Object.entries(perfiles).find(([,p]) => score >= p.umbral[0] && score <= p.umbral[1])[0];

    return `<div class="insight-item">
        <div class="insight-title">üìä Perfil de Eficiencia: ${perfil} (${score.toFixed(0)}/100)</div>
        <div class="insight-description">${perfiles[perfil].narrativa}</div>
        <div class="insight-recommendation">
            <strong>Meta sugerida:</strong> ${perfiles[perfil].meta}
        </div>
    </div>`;
}
function simularOptimizacion() {
    const escenario = document.getElementById('whatIfScenario').value;
    const d = analyzedData;

    let ahorroMensual = 0;
    let descripcion = '';

    switch(escenario) {
        case 'reducirPhantom50':
            ahorroMensual = d.costoFantasmaMes * 0.5;
            descripcion = `Desconectar aparatos standby ahorrar√≠a ${ahorroMensual.toFixed(2)} MXN/mes`;
            break;
        case 'mejorarFP':
            ahorroMensual = d.costoMes * 0.08;
            descripcion = 'Reemplazar cargadores y equipos viejos';
            break;
        case 'reprogramarPico':
            ahorroMensual = d.costoMes * 0.12;
            descripcion = 'Mover lavadora/secadora a 2am';
            break;
        case 'aislarCasa':
            ahorroMensual = d.costoMes * 0.20;
            descripcion = 'Aislamiento t√©rmico reduce AC en 30%';
            break;
    }

    if (ahorroMensual > 0) {
        const roiAnual = (ahorroMensual * 12) / 5000; // Asumiendo inversi√≥n de $5000 en equipos

        document.getElementById('simulationResult').innerHTML = `
            <div class="metric-card" style="background: linear-gradient(135deg, #2ecc71, #27ae60); color: white;">
                <div class="metric-icon">üí∞</div>
                <div class="metric-label">Ahorro Mensual Proyectado</div>
                <div class="metric-value">${ahorroMensual.toFixed(2)} MXN</div>
                <div class="metric-detail">
                    Anual: ${(ahorroMensual * 12).toFixed(2)} MXN<br>
                    ROI Estimado: ${(roiAnual * 100).toFixed(0)}% al a√±o
                </div>
            </div>
        `;
        document.getElementById('simulationResult').style.display = 'grid';
    }
}
// Generador de reportes PDF (simulado)
function generarReporteEjecutivo() {
    const d = analyzedData;

    const reporte = {
        fecha: new Date().toISOString(),
        score: d.scoreEficiencia,
        consumoMensual: d.tuConsumoMensual,
        costo: d.costoMes,
        top3Ahorros: d.clusters.slice(0,3).map(c => ({
            aparato: c.tipo,
            ahorro: c.costoMensualEstimado * 0.4
        })),
        alertas: [
            d.consumoBase > 150 ? 'Consumo fantasma cr√≠tico' : null,
            d.factorPotenciaPromedio < 0.85 ? 'Bajo factor de potencia' : null
        ].filter(Boolean),
        recomendaciones: generarDiagnosticoNLP()
    };

    // Simula descarga
    const blob = new Blob([JSON.stringify(reporte, null, 2)], {type: 'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `reporte_energia_${new Date().toISOString().slice(0,10)}.json`;
    a.click();
}
    </script>
</body>
</html>
